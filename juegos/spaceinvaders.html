<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<title>Space Maths</title>
<style>
:root{--accent:#1d4ed8;--accent2:#2563eb;--text:#1e293b;--vh:1vh}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#07102a 0%, #021022 100%);color:var(--text);display:flex;justify-content:center;align-items:center;min-height:100vh;overflow:auto;touch-action:auto}
@media (pointer:coarse){canvas{touch-action:none}body{touch-action:auto;overflow:auto}}
.game-wrap{width:100%;max-width:900px;background:linear-gradient(180deg,#ffffffee,#f8fafcdd);border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.5);position:relative;overflow:hidden}
.panel{background:#f1f5f9;padding:8px 10px;border-radius:10px;margin:8px;display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:8px}
.problem{font-size:clamp(20px,4vw,28px);font-weight:700;color:var(--accent)}
.stats{font-size:clamp(14px,3vw,18px);color:#1e3a8a}
button.play{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;padding:8px 14px;border-radius:8px;font-weight:700;cursor:pointer}
canvas{width:100%;height:calc(var(--vh) * 60);display:block;background:transparent;border-top:1px solid #cbd5e1;border-bottom:1px solid #cbd5e1}
.overlay{position:absolute;inset:0;backdrop-filter:blur(4px);display:flex;justify-content:center;align-items:center}
.overlay-card{background:#fff;padding:18px;border-radius:12px;text-align:center;box-shadow:0 4px 16px rgba(0,0,0,0.15)}
.small{font-size:clamp(12px,2.8vw,15px);color:#475569}.hide{display:none!important}.hud-right{display:flex;gap:8px;align-items:center}.full-btn{background:#fff;padding:6px 8px;border-radius:8px;border:1px solid #e2e8f0;cursor:pointer}
</style>
</head>
<body>
<div class="game-wrap" id="gameWrap">
  
  <div id="menu" class="panel" style="flex-direction:column;text-align:center;">
    <h2>ðŸš€ Space Maths</h2>
    <div>
      Velocidad:
      <select id="speedLevel">
        <option value="1">Lenta</option>
        <option value="2">Media</option>
        <option value="3">RÃ¡pida</option>
      </select>
      &nbsp; Dificultad:
      <select id="diffLevel">
        <option value="1">Sumas</option>
        <option value="2">Sumas y Restas</option>
        <option value="3">+ MultiplicaciÃ³n</option>
      </select>
    </div>
    <button id="btnStart" class="play">Iniciar juego</button>
  </div>

  <div id="hud" class="panel hide">
    <div>Problema: <span id="problem" class="problem">â€”</span></div>
    <div class="hud-right">
      <div>Puntos: <span id="score" class="stats">0</span></div>
      <div>Vidas: <span id="lives" class="stats">3</span></div>
      <div>RÃ©cord: <span id="highscore" class="stats">0</span></div>
      <button id="fullscreenBtn" class="full-btn">Pantalla</button>
    </div>
  </div>

  <div style="position:relative;">
    <canvas id="canvas"></canvas>

    <div id="overlay" class="overlay" style="display:none;">
      <div class="overlay-card">
        <h2 id="endTitle">Â¡Fin!</h2>
        <p class="small">Puntos: <span id="endScore">0</span></p>
        <p class="small">RÃ©cord: <span id="endHigh">0</span></p>
        <div style="display:flex;gap:8px;justify-content:center;margin-top:8px;flex-wrap:wrap;">
          <button id="endBtn" class="play">Reiniciar</button>
          <button id="shareBtn" class="play">Compartir</button>
        </div>
      </div>
    </div>
  </div>

  <div style="padding:1em;text-align:center;">
    <h3>Sobre el juego</h3>
    <p class="small">
      <strong>Space Maths</strong> es un minijuego educativo basado en space invader para mejorar el cÃ¡lculo mental de los peques.
    </p>
  </div>
</div>

<!-- Audio -->
<audio id="bgm" loop preload="auto">
  <source src="https://files.catbox.moe/x6f0zv.mp3" type="audio/mpeg">
</audio>
<audio id="sndShoot" preload="auto">
  <source src="https://assets.mixkit.co/sfx/preview/mixkit-fast-small-sweep-transition-166.wav" type="audio/wav">
</audio>
<audio id="sndExplode" preload="auto">
  <source src="https://assets.mixkit.co/sfx/preview/mixkit-player-explosion-1699.wav" type="audio/wav">
</audio>

<script>
function updateVH(){document.documentElement.style.setProperty("--vh", (window.innerHeight * 0.01) + "px");}
updateVH();window.addEventListener("resize",updateVH);window.addEventListener("orientationchange",updateVH);
</script>

<script>
(() => {
const canvas=document.getElementById("canvas");const ctx=canvas.getContext("2d");
let W,H,score,lives,enemies,bullets,player,frame,gameOver=false,targetX;
let speedLevel=1,diffLevel=1,problem;
const scoreE=document.getElementById("score");const livesE=document.getElementById("lives");const probE=document.getElementById("problem");
const overlay=document.getElementById("overlay");const endScore=document.getElementById("endScore");
const highDisplay=document.getElementById("highscore");const endHigh=document.getElementById("endHigh");
const bgm=document.getElementById("bgm");const sndShoot=document.getElementById("sndShoot");const sndExplode=document.getElementById("sndExplode");
const HIGH_KEY = 'spaceMathsHighScore_v1';let highScore = Number(localStorage.getItem(HIGH_KEY) || 0);highDisplay.textContent = highScore;

// stars
const stars = [];
function initStars(){stars.length=0;const n = Math.max(40, Math.round((window.innerWidth/8)));for(let i=0;i<n;i++) stars.push({x:Math.random()*W,y:Math.random()*H,z:Math.random()*1.4});}

function r(n){return Math.floor(Math.random()*n);} 
function rand(a,b){return a+Math.floor(Math.random()*(b-a+1));}
function genProblem(){const ops=diffLevel===1?["+"]:diffLevel===2?["+","-"]:["+","-","x"];const op=ops[r(ops.length)];let a=rand(1,12),b=rand(1,12);if(op==="-"&&a<b)[a,b]=[b,a];return {a,b,op,res:op==="+"?a+b:op==="-"?a-b:a*b};}

// particles
const particles = [];
function createExplosion(x,y,color){ for(let i=0;i<28;i++){ particles.push({ x: x + (Math.random()-0.5)*8, y: y + (Math.random()-0.5)*8, dx: (Math.random()-0.5)*6, dy: (Math.random()-0.5)*6, size: Math.random()*4+1.5, life: 40 + Math.random()*10, color: color, alpha:1 }); } }

function spawnEnemies(){
  enemies=[];
  const n=rand(4,6);
  const correctIndex=r(n);
  const baseSpeed=(speedLevel===1?0.01:speedLevel===2?0.4:0.8)/10;
  const usedValues=new Set();
  const spacing=Math.max(60,(W-160)/n);
  const wBase = Math.max(48, Math.min(80, Math.floor((W-120)/n)));

  for(let i=0;i<n;i++){
    let v;
    if(i===correctIndex){ v = problem.res; usedValues.add(v); }
    else{
      let attempts=0;
      do{ v = rand(Math.max(0,problem.res-10),problem.res+10); attempts++; if(attempts>50) break; } while(usedValues.has(v) || v===problem.res);
      usedValues.add(v);
    }
    enemies.push({v,x:80 + i*spacing,y:rand(40,100),w:wBase,h:Math.max(40,Math.floor(wBase*0.6)),s:baseSpeed+Math.random()*0.4,exploding:false,explosionColor:null,removeAt:0});
  }
  if(!enemies.some(e=>e.v===problem.res)){ const idx = r(enemies.length); enemies[idx].v = problem.res; }
}

function start(){
  speedLevel = +document.getElementById("speedLevel").value;
  diffLevel = +document.getElementById("diffLevel").value;

  document.getElementById("menu").classList.add("hide");
  document.getElementById("hud").classList.remove("hide");

  resizeCanvas();
  score = 0; lives = 3; frame = 0;
  bullets = []; enemies = []; particles.length = 0;

  player = { x: W/2, y: H-60, w: 70, h: 25 };
  targetX = player.x;

  overlay.style.display = "none";
  gameOver = false;

  nextProblem();
  bgm.volume = 0.35;
  bgm.play().catch(()=>{});
  requestAnimationFrame(loop);
}

function nextProblem(){problem=genProblem();probE.textContent=`${problem.a} ${problem.op} ${problem.b} = ?`;spawnEnemies();}

function saveHigh(){if(score>highScore){highScore=score;localStorage.setItem(HIGH_KEY,String(highScore));highDisplay.textContent=highScore;endHigh.textContent=highScore;return true;}return false}

function loseLife(){if(navigator.vibrate) navigator.vibrate(150);lives--;livesE.textContent=lives;if(lives<=0)end();}

function hitEnemy(index){
  const e = enemies[index]; if(!e || e.exploding) return;
  const correct = (e.v === problem.res);
  e.exploding = true; e.explosionColor = correct ? '#34d399' : '#ef4444';
  e.removeAt = performance.now() + 300;
  createExplosion(e.x, e.y, e.explosionColor);
  if(sndExplode) try{sndExplode.currentTime=0; sndExplode.play();}catch(e){}
  if(correct){ score += 10; scoreE.textContent = score; setTimeout(()=>{ if(!gameOver) nextProblem(); }, 350);} 
  else { score = Math.max(0, score-5); scoreE.textContent = score; }
}

function shoot(){ bullets.push({x:player.x, y:player.y, dy:10}); if(sndShoot) try{ sndShoot.currentTime=0; sndShoot.play(); }catch(e){} }

function update(){frame++; 
  // movimiento suave hacia targetX
  if(targetX !== undefined){
    const dx = targetX - player.x;
    const speed = 6;
    if(Math.abs(dx) <= speed){
      player.x = targetX;
      targetX = undefined;
      shoot();
    } else {
      player.x += dx * 0.2;
    }

  }

  bullets.forEach((b,i)=>{ b.y -= b.dy; if(b.y < 0) bullets.splice(i,1); });

  const now = performance.now();
  for(let i=enemies.length-1;i>=0;i--){
    const e = enemies[i]; if(e.exploding){ if(now >= e.removeAt){ enemies.splice(i,1); } continue; }
    e.y += e.s; if(e.y > H-20){ enemies.splice(i,1); loseLife(); }
  }

  for(let bi = bullets.length-1; bi >= 0; bi--){
    const b = bullets[bi];
    for(let ei = enemies.length-1; ei >= 0; ei--){
      const e = enemies[ei]; if(e.exploding) continue;
      if(b.x > e.x - e.w/2 && b.x < e.x + e.w/2 && b.y > e.y - e.h/2 && b.y < e.y + e.h/2){
        bullets.splice(bi,1); hitEnemy(ei); break;
      }
    }
  }

  for(let i=particles.length-1;i>=0;i--){ const p = particles[i]; p.x += p.dx; p.y += p.dy; p.dy += 0.12; p.life--; p.alpha = p.life/40; if(p.life <= 0) particles.splice(i,1); }

  stars.forEach(s=>{ s.y += 0.45 * s.z; if(s.y > H) s.y = 0; });

  // solo generar nueva cuenta cuando no hay enemigos y no hay balas
  if( bullets.length === 0 && !gameOver) nextProblem();

}

function draw(){ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#001026'; ctx.fillRect(0,0,W,H);
  for(const s of stars){ const size = 1.2 * s.z; ctx.globalAlpha = 0.9 * s.z; ctx.fillStyle = '#ffffff'; ctx.fillRect(s.x, s.y, size, size);} ctx.globalAlpha = 1;
  const enemyFontSize = (W < 420) ? 18 : 28; ctx.font = `bold ${enemyFontSize}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  enemies.forEach(e => {
    if(e.exploding){ ctx.fillStyle = e.explosionColor || '#ef4444'; ctx.beginPath(); ctx.arc(e.x, e.y, Math.max(e.w,e.h)/1.2, 0, Math.PI*2); ctx.fill(); return;}
    ctx.fillStyle = '#93c5fd'; ctx.fillRect(e.x - e.w/2, e.y - e.h/2, e.w, e.h);
    ctx.fillStyle = '#000'; ctx.fillText(e.v, e.x, e.y);
  });
  ctx.fillStyle = '#1d4ed8'; ctx.beginPath(); ctx.moveTo(player.x,player.y-15); ctx.lineTo(player.x-35,player.y+20); ctx.lineTo(player.x+35,player.y+20); ctx.closePath(); ctx.fill();
  ctx.fillStyle = '#1e3a8a'; bullets.forEach(b => ctx.fillRect(b.x-3, b.y-12, 6, 12));
  for(const p of particles){ ctx.globalAlpha = Math.max(0, p.alpha); ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill(); } ctx.globalAlpha = 1;
}

function loop(){ if(gameOver) return; update(); draw(); requestAnimationFrame(loop); }

canvas.addEventListener('click', (e) => {
  const rect = canvas.getBoundingClientRect();
  targetX = e.clientX - rect.left;
});

function end(){gameOver=true;endScore.textContent=score;overlay.style.display='flex';bgm.pause();saveHigh();}

document.getElementById('btnStart').onclick = start;
document.getElementById('endBtn').onclick = ()=>{ document.getElementById('menu').classList.remove('hide'); document.getElementById('hud').classList.add('hide'); overlay.style.display='none'; };
document.getElementById('shareBtn').onclick = async ()=>{ const text = `He conseguido ${score} puntos en Space Maths ðŸš€`; const url = window.location.href; if(navigator.share){ try{ await navigator.share({title:'Space Maths',text,url}); }catch(e){} } else { const tw = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`; window.open(tw,'_blank'); } };

function resizeCanvas(){ const scale = window.devicePixelRatio || 1; const viewH = window.innerHeight * 0.60; const viewW = document.querySelector('.game-wrap').clientWidth; canvas.width = viewW * scale; canvas.height = viewH * scale; ctx.setTransform(scale,0,0,scale,0,0); W = canvas.width/scale; H = canvas.height/scale; initStars(); }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();
})();
</script>
</body>
</html>
